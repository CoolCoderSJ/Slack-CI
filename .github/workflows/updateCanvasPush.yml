name: Update Canvas Automatically

on:
  push:
    branches:
      - '*'

jobs:
  update_canvas:
    runs-on: ubuntu-latest
    environment: production
    env:
      INPUT_PATH: "contents.md"
      CANVAS_ID: "C02E3KZQX1H"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Read file
      id: read_file
      run: |
        echo "Reading file $INPUT_PATH"
        cat $INPUT_PATH
        echo "CONTENTS=$(base64 "$INPUT_PATH")" >> $GITHUB_ENV
        
    - name: Update Canvas
      env:
        TOKEN: ${{ secrets.SLACK_TOKEN }}
        CONTENTS: echo "${{ env.CONTENTS }}" | base64 --decode
      run: |
        response=$(curl -X POST 'https://slack.com/api/canvases.edit' \
          --header 'Content-Type: application/json' \
          --header "Authorization: Bearer $TOKEN" \
          --data "{
              \"canvas_id\": \"$CANVAS_ID\",
              \"token\": \"$TOKEN\",
              \"changes\": [
                {
                  \"operation\": \"replace\",
                  \"document_content\": {
                    \"type\": \"markdown\",
                    \"markdown\": \"$CONTENTS\"
                  }
                }
              ]
          }" --fail)
        echo $response

        status=$(echo $response | \
            python3 -c "import sys, json; print(json.load(sys.stdin)['ok'])")

        if [ "$status" = "True" ]; then
            echo "Canvas updated successfully"
        else
            echo "Failed to update canvas"
            exit 1
        fi